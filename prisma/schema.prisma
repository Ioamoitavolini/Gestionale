// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Modello per utenti (admin, receptionist)
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(RECEPTIONIST)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  appointments Appointment[]
  notifications Notification[]

  @@index([email])
}

enum UserRole {
  ADMIN
  RECEPTIONIST
}

// Modello per clienti
model Client {
  id           String   @id @default(cuid())
  firstName    String
  lastName     String
  email        String?
  phone        String
  whatsappNumber String // Formato E.164: +39xxxxxxxxx
  address      String?
  city         String?
  postalCode   String?
  dateOfBirth  DateTime?
  notes        String?
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  deletedAt    DateTime? // Soft delete

  appointments Appointment[]
  @@index([phone])
  @@index([whatsappNumber])
  @@index([deletedAt])
}

// Modello per appuntamenti
model Appointment {
  id          String    @id @default(cuid())
  clientId    String
  userId      String
  serviceId   String
  title       String    // Nome servizio
  description String?
  startTime   DateTime  // Orario inizio (UTC)
  endTime     DateTime  // Orario fine (UTC)
  status      AppointmentStatus @default(SCHEDULED)
  price       Float?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime? // Soft delete

  client    Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  provider  User   @relation(fields: [userId], references: [id], onDelete: Restrict)
  service   Service @relation(fields: [serviceId], references: [id], onDelete: Restrict)
  notifications Notification[]

  @@index([clientId])
  @@index([userId])
  @@index([startTime])
  @@index([status])
  @@index([deletedAt])
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

// Modello per servizi/trattamenti
model Service {
  id          String   @id @default(cuid())
  name        String
  description String?
  duration    Int      // Durata in minuti
  price       Float
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  appointments Appointment[]

  @@index([active])
}

// Modello per notifiche WhatsApp
model Notification {
  id             String   @id @default(cuid())
  appointmentId  String
  userId         String
  clientId       String
  type           NotificationType @default(REMINDER_24H)
  message        String
  status         NotificationStatus @default(QUEUED)
  twilioSid      String?            // Message SID da Twilio
  sentAt         DateTime?
  readAt         DateTime?
  failureReason  String?
  retryCount     Int      @default(0)
  maxRetries     Int      @default(3)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  deletedAt      DateTime? // Soft delete

  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [userId], references: [id], onDelete: Restrict)
  client      Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([appointmentId])
  @@index([retryCount])
  @@index([createdAt])
  @@index([deletedAt])
}

enum NotificationType {
  REMINDER_24H
  REMINDER_1H
  CONFIRMATION
  CANCELLATION
  RESCHEDULE
}

enum NotificationStatus {
  QUEUED
  SENDING
  SENT
  FAILED
  DELIVERED
  READ
}
